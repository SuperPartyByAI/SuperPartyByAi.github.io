<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SuperParty</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-soft: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon { font-size: 28px; }
    .logo-text { font-weight: 700; font-size: 18px; }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 15px 0;
    }

    .nav-section { margin-bottom: 20px; }
    
    .nav-section-title {
      padding: 8px 20px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text);
    }

    .nav-item:hover { background: var(--bg); }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }

    /* MAIN */
    .main { margin-left: 260px; min-height: 100vh; }

    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 15px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .page-title { font-size: 20px; font-weight: 600; }

    .content { padding: 25px; max-width: 1200px; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .welcome-card {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: var(--radius);
      padding: 30px;
      margin-bottom: 25px;
    }

    .welcome-card h2 { margin-bottom: 8px; }
    .welcome-card p { opacity: 0.9; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-soft);
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: var(--primary-dark); }

    /* TABLE */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      font-weight: 600;
      background: var(--bg);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
      }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
      .menu-toggle { display: block; }
      .content { padding: 15px; }
    }

    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    .overlay.active { display: block; }

    /* CHAT */
    .chat-toggle {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(59,130,246,0.4);
      z-index: 200;
      transition: transform 0.2s;
    }

    .chat-toggle:hover { transform: scale(1.1); }

    .chat-window {
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 380px;
      height: 500px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      z-index: 200;
      overflow: hidden;
    }

    .chat-window.hidden { display: none; }

    .chat-header {
      padding: 15px 20px;
      background: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h3 { font-size: 16px; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .chat-msg.user {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-msg.ai {
      background: var(--bg);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-input-area {
      padding: 15px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .chat-input:focus { border-color: var(--primary); }

    .chat-send {
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .chat-window {
        width: calc(100% - 20px);
        height: 60vh;
        right: 10px;
        bottom: 90px;
      }
    }

    /* SCAN POPUP */
    .scan-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 300;
      width: 90%;
      max-width: 400px;
    }

    .scan-popup.active { display: block; }

    .scan-popup h3 { margin-bottom: 15px; }

    .scan-popup .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
    .upload-area .icon { font-size: 40px; margin-bottom: 10px; }
    .upload-area p { color: var(--text-soft); font-size: 14px; }

    .loading { text-align: center; padding: 40px; color: var(--text-soft); }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="logo-icon" id="logoIcon">üéâ</span>
      <span class="logo-text" id="logoText">SuperParty</span>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
  </aside>

  <div class="overlay" id="overlay"></div>

  <main class="main">
    <header class="header">
      <button class="menu-toggle" id="menuToggle">‚ò∞</button>
      <h1 class="page-title" id="pageTitle">AcasƒÉ</h1>
      <div></div>
    </header>
    <div class="content" id="content">
      <div class="loading">Se √ÆncarcƒÉ...</div>
    </div>
  </main>

  <button class="chat-toggle" id="chatToggle">üí¨</button>

  <div class="scan-popup" id="scanPopup">
    <button class="close-btn" onclick="closeScanPopup()">‚úï</button>
    <h3 id="scanPopupTitle">üì∑ ScaneazƒÉ document</h3>
    <div class="upload-area" id="uploadArea">
      <div class="icon">üì§</div>
      <p>Click sau trage fi»ôierul</p>
      <input type="file" id="fileInput" accept="image/*,.pdf" style="display:none;">
    </div>
    <div id="scanStatus" style="display:none;text-align:center;padding:20px;"></div>
  </div>

  <div class="chat-window hidden" id="chatWindow">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <span>ü§ñ</span>
        <h3>SuperParty AI</h3>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="Scrie un mesaj...">
      <button class="chat-send" id="chatSend">Trimite</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyfyw63pxz5z6hW0abaQXEvu1aU1OPSykc2v8Jz23-z2RFY14rw1zU90ETUEn8TLZXd/exec";
    const GM_PASSWORD = "Gmandrei209512!";
    const ADMIN_PASSWORD = "Adminandrei209512!";

    // ===== STATE =====
    let currentMode = "standard";
    let editMode = false;
    let currentPage = null;
    let appData = { pagini: [], tabele: [], elemente: [], scanari: [], stiluri: {} };
    let currentScanType = null;

    // ===== ELEMENTS =====
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const menuToggle = document.getElementById("menuToggle");
    const sidebarNav = document.getElementById("sidebarNav");
    const pageTitle = document.getElementById("pageTitle");
    const content = document.getElementById("content");
    const chatToggle = document.getElementById("chatToggle");
    const chatWindow = document.getElementById("chatWindow");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const scanPopup = document.getElementById("scanPopup");
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const scanStatus = document.getElementById("scanStatus");

    // ===== EVENTS =====
    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      overlay.classList.toggle("active");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("active");
      closeScanPopup();
    });

    chatToggle.addEventListener("click", () => chatWindow.classList.toggle("hidden"));
    chatSend.addEventListener("click", handleChatSend);
    chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") handleChatSend(); });

    // ===== LOAD APP =====
    async function loadApp() {
      try {
        const response = await fetch(BACKEND_URL + "?action=loadApp");
        const data = await response.json();
        if (data.ok) {
          appData = data.data;
          applyStyles();
          renderNav();
          
          // NavigheazƒÉ la prima paginƒÉ vizibilƒÉ
          const firstPage = appData.pagini.find(p => p.vizibil && (p.mod === "normal" || p.mod === "all"));
          if (firstPage) navigateTo(firstPage);
        }
      } catch (e) {
        content.innerHTML = '<div class="card"><div class="empty-state">Eroare la √ÆncƒÉrcare</div></div>';
      }
    }

    // ===== APPLY STYLES =====
    function applyStyles() {
      const s = appData.stiluri;
      if (s.primary?.color) {
        document.documentElement.style.setProperty('--primary', s.primary.color);
        document.documentElement.style.setProperty('--primary-dark', shadeColor(s.primary.color, -20));
      }
      if (s.sidebar?.background) document.documentElement.style.setProperty('--card', s.sidebar.background);
      if (s.text?.color) document.documentElement.style.setProperty('--text', s.text.color);
      if (s.background?.color) document.documentElement.style.setProperty('--bg', s.background.color);
      if (s.app?.font) document.body.style.fontFamily = s.app.font + ', sans-serif';
      if (s.app?.title) {
        document.getElementById("logoText").textContent = s.app.title;
        document.title = s.app.title;
      }
      if (s.app?.logo) document.getElementById("logoIcon").textContent = s.app.logo;
    }

    function shadeColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    // ===== RENDER NAV =====
    function renderNav() {
      let html = '';
      
      // Normal pages
      const normalPages = appData.pagini.filter(p => p.vizibil && (p.mod === "normal" || p.mod === "all"));
      if (normalPages.length > 0) {
        html += '<div class="nav-section"><div class="nav-section-title">Meniu</div>';
        normalPages.forEach(p => {
          html += `<div class="nav-item" data-page-id="${p.id}"><span class="icon">${p.icon || 'üìÑ'}</span><span>${p.nume}</span></div>`;
        });
        html += '</div>';
      }

      // Admin pages
      if (currentMode === "admin" || currentMode === "gm") {
        const adminPages = appData.pagini.filter(p => p.vizibil && p.mod === "admin");
        html += '<div class="nav-section"><div class="nav-section-title">Admin</div>';
        adminPages.forEach(p => {
          html += `<div class="nav-item" data-page-id="${p.id}"><span class="icon">${p.icon || 'üìÑ'}</span><span>${p.nume}</span></div>`;
        });
        html += '</div>';
      }

      // GM pages
      if (currentMode === "gm") {
        const gmPages = appData.pagini.filter(p => p.vizibil && p.mod === "gm");
        html += '<div class="nav-section"><div class="nav-section-title">GM</div>';
        gmPages.forEach(p => {
          html += `<div class="nav-item" data-page-id="${p.id}"><span class="icon">${p.icon || 'üìÑ'}</span><span>${p.nume}</span></div>`;
        });
        html += `<div class="nav-item" data-page-id="creier-ai"><span class="icon">üß†</span><span>Creier AI</span></div>`;
        html += `<div class="nav-item" data-page-id="de-verificat"><span class="icon">‚úÖ</span><span>De verificat</span></div>`;
        html += `<div class="nav-item" data-page-id="reguli-fundamentale"><span class="icon">üîí</span><span>Reguli Fundamentale</span></div>`;
        html += `<div class="nav-item" data-page-id="conversatii"><span class="icon">üí¨</span><span>Conversa»õii</span></div>`;
        html += '</div>';
      }

      sidebarNav.innerHTML = html;

      // Events
      document.querySelectorAll(".nav-item").forEach(item => {
        item.addEventListener("click", () => {
          const pageId = item.dataset.pageId;
          
          if (pageId === "creier-ai") showCreierAI();
          else if (pageId === "de-verificat") showDeVerificat();
          else if (pageId === "reguli-fundamentale") showReguliFundamentale();
          else if (pageId === "conversatii") showConversatii();
          else {
            const page = appData.pagini.find(p => String(p.id) === pageId);
            if (page) navigateTo(page);
          }
          
          document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
          item.classList.add("active");
          sidebar.classList.remove("open");
          overlay.classList.remove("active");
        });
      });
    }

    // ===== NAVIGATE =====
    function navigateTo(page) {
      currentPage = page;
      pageTitle.textContent = page.nume;
      
      const pageTables = appData.tabele.filter(t => t.paginaId === page.id && t.vizibil !== false);
      const pageElements = (appData.elemente || []).filter(e => e.paginaId === page.id);
      
      let html = `<div class="welcome-card"><h2>${page.icon || ''} ${page.nume}</h2></div>`;
      
      if (pageElements.length > 0) {
        html += '<div class="card"><div class="card-title">Ac»õiuni</div><div>';
        pageElements.forEach(el => { html += renderElement(el); });
        html += '</div></div>';
      }
      
      if (pageTables.length === 0 && pageElements.length === 0) {
        html += '<div class="card"><div class="empty-state">PaginƒÉ goalƒÉ</div></div>';
      } else {
        pageTables.forEach(table => {
          html += `<div class="card"><div class="card-title">${table.numeTabel}</div><div id="table-${table.numeTabel}"><div class="loading">Se √ÆncarcƒÉ...</div></div></div>`;
        });
      }
      
      content.innerHTML = html;
      pageTables.forEach(table => loadTableData(table));
    }

    function renderElement(el) {
      switch(el.tip) {
        case 'buton': return `<button class="btn btn-primary" style="margin:5px;">${el.nume}</button>`;
        case 'dropdown':
          const opts = el.optiuni ? el.optiuni.split(',').map(o => `<option>${o.trim()}</option>`).join('') : '';
          return `<div style="margin:10px 0;"><label style="display:block;margin-bottom:5px;">${el.nume}</label><select class="chat-input" style="width:200px;">${opts}</select></div>`;
        case 'checkbox': return `<label style="display:flex;align-items:center;gap:8px;margin:10px 0;cursor:pointer;"><input type="checkbox"><span>${el.nume}</span></label>`;
        default: return `<div style="margin:10px 0;"><label style="display:block;margin-bottom:5px;">${el.nume}</label><input type="text" class="chat-input" style="width:100%;"></div>`;
      }
    }

    async function loadTableData(table) {
      try {
        const response = await fetch(BACKEND_URL + "?action=loadTable&table=" + table.numeTabel);
        const data = await response.json();
        const container = document.getElementById("table-" + table.numeTabel);
        
        if (data.ok && data.data.rows.length > 0) {
          let html = '<table class="data-table"><thead><tr>';
          data.data.headers.forEach(h => { html += `<th>${h}</th>`; });
          html += '</tr></thead><tbody>';
          data.data.rows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => { html += `<td>${cell || ''}</td>`; });
            html += '</tr>';
          });
          html += '</tbody></table>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty-state">Nicio √Ænregistrare</div>';
        }
      } catch (e) {
        document.getElementById("table-" + table.numeTabel).innerHTML = '<div class="empty-state">Eroare</div>';
      }
    }

    // ===== GM PAGES =====
    async function showCreierAI() {
      pageTitle.textContent = "Creier AI";
      content.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';
      
      try {
        const response = await fetch(BACKEND_URL + "?action=loadCunostinte");
        const data = await response.json();
        
        let html = '<div class="welcome-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);"><h2>üß† Creier AI</h2><p>Tot ce »ôtie AI-ul</p></div>';
        
        if (data.ok && data.data.length > 0) {
          // Group by category
          const grouped = {};
          data.data.forEach(c => {
            const cat = c.categorie || 'general';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(c);
          });
          
          for (const cat in grouped) {
            html += `<div class="card"><div class="card-title">${cat.toUpperCase()}</div>`;
            grouped[cat].forEach(c => {
              html += `<div style="padding:8px 0;border-bottom:1px solid var(--border);">‚Ä¢ ${c.informatie}</div>`;
            });
            html += '</div>';
          }
        } else {
          html += '<div class="card"><div class="empty-state">AI-ul nu »ôtie nimic √ÆncƒÉ.<br><br>√énva»õƒÉ-l din chat: <code>√Ænva»õƒÉ: [informa»õie]</code></div></div>';
        }
        
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<div class="card"><div class="empty-state">Eroare la √ÆncƒÉrcare</div></div>';
      }
    }

    async function showDeVerificat() {
      pageTitle.textContent = "De verificat";
      content.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';
      
      try {
        const response = await fetch(BACKEND_URL + "?action=loadDeVerificat");
        const data = await response.json();
        
        let html = '<div class="welcome-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);"><h2>‚úÖ De verificat</h2><p>Cuno»ôtin»õe de la utilizatori</p></div>';
        
        if (data.ok && data.data.length > 0) {
          data.data.forEach(item => {
            html += `<div class="card">
              <div style="margin-bottom:10px;"><strong>Sursa:</strong> ${item.sursa}</div>
              <div style="margin-bottom:15px;">${item.informatie}</div>
              <div style="display:flex;gap:10px;">
                <button class="btn btn-primary" onclick="verificaCunostinta('${item.id}', 'aproba')">‚úÖ AprobƒÉ</button>
                <button class="btn" style="background:#ef4444;color:white;" onclick="verificaCunostinta('${item.id}', 'respinge')">‚ùå Respinge</button>
              </div>
            </div>`;
          });
        } else {
          html += '<div class="card"><div class="empty-state">Nimic de verificat! üéâ</div></div>';
        }
        
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<div class="card"><div class="empty-state">Eroare la √ÆncƒÉrcare</div></div>';
      }
    }

    async function verificaCunostinta(id, actiune) {
      try {
        const url = BACKEND_URL + "?action=verificaCunostinta&id=" + encodeURIComponent(id) + "&actiune=" + encodeURIComponent(actiune);
        await fetch(url);
        showDeVerificat();
      } catch (e) { console.error(e); }
    }

    // ===== REGULI FUNDAMENTALE =====
    async function showReguliFundamentale() {
      pageTitle.textContent = "Reguli Fundamentale";
      content.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';
      
      try {
        const response = await fetch(BACKEND_URL + "?action=loadReguli");
        const data = await response.json();
        
        let html = '<div class="welcome-card" style="background:linear-gradient(135deg,#ef4444,#dc2626);"><h2>üîí Reguli Fundamentale</h2><p>Reguli pe care AI-ul le respectƒÉ MEREU</p></div>';
        
        html += '<div class="card"><div class="card-title">AdaugƒÉ RegulƒÉ NouƒÉ</div>';
        html += '<div style="display:flex;gap:10px;"><input type="text" id="regulaNoua" class="chat-input" style="flex:1;" placeholder="Ex: √éntotdeauna salutƒÉ clientul cu BunƒÉ ziua!">';
        html += '<button class="btn btn-primary" onclick="adaugaRegula()">+ AdaugƒÉ</button></div></div>';
        
        html += '<div class="card"><div class="card-title">Reguli Active</div>';
        
        if (data.ok && data.data.length > 0) {
          data.data.forEach((r, idx) => {
            html += `<div style="padding:12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
              <div><strong>#${idx + 1}</strong> &nbsp; "${r.regula}"</div>
              <div style="display:flex;gap:8px;">
                <button class="btn" style="padding:5px 10px;font-size:12px;" onclick="editeazaRegula('${r.id}', '${r.regula.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                <button class="btn" style="padding:5px 10px;font-size:12px;background:#ef4444;color:white;" onclick="stergeRegula('${r.id}')">üóëÔ∏è</button>
              </div>
            </div>`;
          });
        } else {
          html += '<div class="empty-state">Nicio regulƒÉ √ÆncƒÉ.<br>AdaugƒÉ prima regulƒÉ!</div>';
        }
        
        html += '</div>';
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<div class="card"><div class="empty-state">Eroare la √ÆncƒÉrcare</div></div>';
      }
    }

    async function adaugaRegula() {
      const regula = document.getElementById("regulaNoua").value.trim();
      if (!regula) return alert("Scrie o regulƒÉ!");
      
      try {
        const url = BACKEND_URL + "?action=adaugaRegula&regula=" + encodeURIComponent(regula);
        await fetch(url);
        document.getElementById("regulaNoua").value = "";
        showReguliFundamentale();
      } catch (e) { console.error(e); }
    }

    async function editeazaRegula(id, regulaVeche) {
      const regulaNoua = prompt("EditeazƒÉ regula:", regulaVeche);
      if (!regulaNoua || regulaNoua === regulaVeche) return;
      
      try {
        const url = BACKEND_URL + "?action=editeazaRegula&id=" + encodeURIComponent(id) + "&regula=" + encodeURIComponent(regulaNoua);
        await fetch(url);
        showReguliFundamentale();
      } catch (e) { console.error(e); }
    }

    async function stergeRegula(id) {
      if (!confirm("Sigur »ôtergi aceastƒÉ regulƒÉ?")) return;
      
      try {
        const url = BACKEND_URL + "?action=stergeRegula&id=" + encodeURIComponent(id);
        await fetch(url);
        showReguliFundamentale();
      } catch (e) { console.error(e); }
    }

    // ===== CONVERSA»öII =====
    async function showConversatii() {
      pageTitle.textContent = "Conversa»õii";
      content.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';
      
      try {
        const response = await fetch(BACKEND_URL + "?action=loadConversatii");
        const data = await response.json();
        
        let html = '<div class="welcome-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);"><h2>üí¨ Conversa»õii</h2><p>Tot ce a √Æntrebat oricine</p></div>';
        
        if (data.ok && data.data.length > 0) {
          data.data.forEach((c, idx) => {
            const timestamp = new Date(c.timestamp).toLocaleString('ro-RO');
            const statusIcon = c.status === 'ok' ? '‚úÖ' : c.status === 'corectat' ? 'üìù' : '‚è≥';
            const statusClass = c.status === 'ok' ? 'background:#d1fae5;' : c.status === 'corectat' ? 'background:#dbeafe;' : '';
            
            html += `<div class="card" style="${statusClass}">
              <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <strong>#${idx + 1}</strong>
                <span style="color:var(--text-soft);font-size:12px;">${statusIcon} ${timestamp} | ${c.user} (${c.mod})</span>
              </div>
              <div style="margin-bottom:8px;"><strong>User:</strong> "${c.mesaj}"</div>
              <div style="margin-bottom:12px;color:var(--text-soft);"><strong>AI:</strong> "${c.raspuns ? c.raspuns.substring(0, 200) : ''}${c.raspuns && c.raspuns.length > 200 ? '...' : ''}"</div>
              ${c.status !== 'ok' && c.status !== 'corectat' ? `
              <div style="display:flex;gap:10px;">
                <button class="btn btn-primary" style="padding:6px 12px;font-size:12px;" onclick="marcheazaOK('${c.id}')">‚úÖ OK</button>
                <button class="btn" style="padding:6px 12px;font-size:12px;background:#f59e0b;color:white;" onclick="corecteazaConversatie('${c.id}', '${c.mesaj.replace(/'/g, "\\'")}')">‚úèÔ∏è CorecteazƒÉ</button>
              </div>` : ''}
            </div>`;
          });
        } else {
          html += '<div class="card"><div class="empty-state">Nicio conversa»õie √ÆncƒÉ.</div></div>';
        }
        
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<div class="card"><div class="empty-state">Eroare la √ÆncƒÉrcare</div></div>';
      }
    }

    async function marcheazaOK(id) {
      try {
        const url = BACKEND_URL + "?action=marcheazaOK&id=" + encodeURIComponent(id);
        await fetch(url);
        showConversatii();
      } catch (e) { console.error(e); }
    }

    async function corecteazaConversatie(id, mesajOriginal) {
      const corectie = prompt("Cum trebuia sƒÉ rƒÉspundƒÉ AI-ul la:\n\"" + mesajOriginal + "\"");
      if (!corectie) return;
      
      try {
        const url = BACKEND_URL + "?action=corecteazaConversatie&id=" + encodeURIComponent(id) + "&corectie=" + encodeURIComponent(corectie);
        await fetch(url);
        showConversatii();
        alert("‚úÖ AI-ul a √ÆnvƒÉ»õat din corec»õie!");
      } catch (e) { console.error(e); }
    }

    // ===== MODE UI =====
    function updateModeUI() { renderNav(); }

    // ===== MODE COMMANDS =====
    function handleModeCommands(text) {
      const lower = text.toLowerCase().trim();

      if (lower === "open mod andrei admin") {
        const pass = prompt("üîê Parola Admin:");
        if (pass === ADMIN_PASSWORD) {
          currentMode = "admin";
          editMode = false;
          updateModeUI();
          pushMessage("ai", "‚úÖ Mod <b>Admin</b> activat!<br><br>Po»õi face ac»õiuni directe (fƒÉrƒÉ dovezi).<br><br>Pentru a edita structura: <code>deschide mod editare</code>");
        } else {
          pushMessage("ai", "‚ùå ParolƒÉ gre»ôitƒÉ!");
        }
        return true;
      }

      if (lower === "open mod andrei gm") {
        const pass = prompt("üîê Parola GM:");
        if (pass === GM_PASSWORD) {
          currentMode = "gm";
          editMode = false;
          updateModeUI();
          pushMessage("ai", "‚úÖ Mod <b>GM</b> activat!<br><br>Vezi √Æn sidebar: Creier AI »ôi De verificat.<br><br>Pentru a edita: <code>deschide mod editare</code>");
        } else {
          pushMessage("ai", "‚ùå ParolƒÉ gre»ôitƒÉ!");
        }
        return true;
      }

      if (lower === "deschide mod editare" || lower === "editare") {
        if (currentMode === "admin" || currentMode === "gm") {
          editMode = true;
          pushMessage("ai", "‚úèÔ∏è <b>Mod editare activ!</b><br><br>" +
            "<b>√énva»õƒÉ:</b> <code>√Ænva»õƒÉ: Elsa costƒÉ 800 lei</code><br>" +
            "<b>Pagini:</b> <code>adaugƒÉ paginƒÉ X √Æn normal/admin/gm</code><br>" +
            "<b>Tabele:</b> <code>adaugƒÉ tabel X cu Col1, Col2</code><br>" +
            "<b>ScanƒÉri:</b> <code>adaugƒÉ scanare X cu Nume, Tel, Data</code><br>" +
            "<b>Stiluri:</b> <code>culoare primarƒÉ rosu</code><br><br>" +
            "C√¢nd termini: <code>inchide mod editare</code>");
        } else {
          pushMessage("ai", "‚ö†Ô∏è Trebuie sƒÉ fii √Æn mod Admin sau GM.");
        }
        return true;
      }

      if (lower === "inchide mod editare" || lower === "gata") {
        editMode = false;
        pushMessage("ai", "‚úÖ Mod editare √Ænchis. Vorbim normal!");
        return true;
      }

      if (lower === "exit" || lower === "iesi") {
        currentMode = "standard";
        editMode = false;
        updateModeUI();
        pushMessage("ai", "üëã Ai ie»ôit din mod special.");
        return true;
      }

      return false;
    }

    // ===== CHAT =====
    function pushMessage(type, html) {
      const div = document.createElement("div");
      div.className = "chat-msg " + type;
      div.innerHTML = html;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function handleChatSend() {
      const text = chatInput.value.trim();
      if (!text) return;

      chatInput.value = "";
      pushMessage("user", text);

      if (handleModeCommands(text)) return;

      // Check for scan request
      const scanRequest = detectScanRequest(text);
      if (scanRequest && currentMode === "standard") {
        openScanPopup(scanRequest.nume, "ScaneazƒÉ " + scanRequest.nume);
        pushMessage("ai", "üì∑ √éncarcƒÉ documentul pentru a continua.");
        return;
      }

      // Check edit commands without edit mode
      const lower = text.toLowerCase();
      const isEditCmd = lower.includes("adaugƒÉ") || lower.includes("adauga") || lower.includes("»ôterge") || lower.includes("culoare") || lower.includes("titlu");
      
      if (isEditCmd && (currentMode === "admin" || currentMode === "gm") && !editMode) {
        pushMessage("ai", "‚ö†Ô∏è Pentru a modifica, activeazƒÉ mai √Ænt√¢i:<br><code>deschide mod editare</code>");
        return;
      }

      pushMessage("ai", "‚è≥ Procesez...");

      try {
        let url = BACKEND_URL + "?action=chat&message=" + encodeURIComponent(text);
        
        if (currentMode === "gm") {
          url += "&mode=gm&password=" + encodeURIComponent(GM_PASSWORD) + "&editMode=" + editMode;
        } else if (currentMode === "admin") {
          url += "&mode=admin&password=" + encodeURIComponent(ADMIN_PASSWORD);
        }

        const response = await fetch(url);
        const data = await response.json();

        // Remove loading
        const msgs = chatMessages.querySelectorAll(".chat-msg.ai");
        const last = msgs[msgs.length - 1];
        if (last?.textContent.includes("Procesez")) last.remove();

        if (data.ok && data.reply) {
          let reply = data.reply.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>').replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
          pushMessage("ai", reply);
          
          if (data.reload) setTimeout(() => loadApp(), 500);
          if (data.requestUpload) openScanPopup(data.scanType, "√éncarcƒÉ document");
        } else {
          pushMessage("ai", "‚ö†Ô∏è " + (data.error || "Eroare"));
        }
      } catch (e) {
        const msgs = chatMessages.querySelectorAll(".chat-msg.ai");
        const last = msgs[msgs.length - 1];
        if (last?.textContent.includes("Procesez")) last.remove();
        pushMessage("ai", "‚ö†Ô∏è Eroare conexiune");
      }
    }

    function detectScanRequest(text) {
      const lower = text.toLowerCase();
      if (lower.includes("scanez") || lower.includes("notez") || lower.includes("√ÆncarcƒÉ") || lower.includes("vreau sƒÉ")) {
        const scans = appData.scanari || [];
        for (const s of scans) {
          if (lower.includes(s.nume.toLowerCase())) return s;
        }
        if (lower.includes("petrecere") || lower.includes("rezerv")) {
          return { nume: "Petreceri", campuri: "Nume,Telefon,Data,Ora,Locatie" };
        }
      }
      return null;
    }

    // ===== SCAN POPUP =====
    function openScanPopup(scanType, title) {
      currentScanType = scanType;
      document.getElementById("scanPopupTitle").textContent = "üì∑ " + title;
      scanPopup.classList.add("active");
      overlay.classList.add("active");
      uploadArea.style.display = "block";
      scanStatus.style.display = "none";
    }

    function closeScanPopup() {
      scanPopup.classList.remove("active");
      overlay.classList.remove("active");
    }

    uploadArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0]); });

    async function handleFileUpload(file) {
      uploadArea.style.display = "none";
      scanStatus.style.display = "block";
      scanStatus.innerHTML = "‚è≥ Se scaneazƒÉ...";

      try {
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const response = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "scanDocument", scanType: currentScanType, image: base64, fileName: file.name, mode: currentMode })
        });

        const data = await response.json();

        if (data.ok) {
          closeScanPopup();
          pushMessage("ai", "‚úÖ <b>Scanat »ôi salvat!</b><br><br>" + data.message.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<b>$1</b>'));
          setTimeout(() => loadApp(), 500);
        } else {
          scanStatus.innerHTML = "‚ùå " + (data.error || "Eroare");
        }
      } catch (e) {
        scanStatus.innerHTML = "‚ùå Eroare la √ÆncƒÉrcare";
      }
    }

    // ===== INIT =====
    loadApp();
    pushMessage("ai", "Salut! üëã Sunt AI-ul SuperParty. Cu ce te pot ajuta?");
  </script>
</body>
</html>
